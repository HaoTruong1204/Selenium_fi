import time
import os
import urllib.parse
import random
import subprocess
import shutil
from datetime import datetime

from PyQt5.QtCore import QThread, pyqtSignal

# Selenium Imports
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# Webdriver-manager
from webdriver_manager.chrome import ChromeDriverManager
# Th√™m th∆∞ vi·ªán cho vi·ªác x√°c ƒë·ªãnh phi√™n b·∫£n Chromium
from packaging import version

# Google URL m·∫∑c ƒë·ªãnh
GOOGLE_URL = "https://www.google.com"

# =============== D·ªÆ LI·ªÜU T√ÄI KHO·∫¢N X√É H·ªòI ===============
# T·∫•t c·∫£ MXH (facebook, instagram, zalo, twitter, shopee)
# Shopee => phone="aa", password="aa"
SOCIAL_ACCOUNTS = {
    "facebook": {
        "url": "https://www.facebook.com",
        "phone": "0333",
        "password": "123"
    },
    "instagram": {
        "url": "https://www.instagram.com/accounts/login",
        "phone": "0333",
        "password": "123"
    },
    "zalo": {
        "url": "https://chat.zalo.me/",
        "phone": "0333",
        "password": "123"
    },
    "twitter": {
        "url": "https://twitter.com/i/flow/login",
        "phone": "0333",
        "password": "123"
    },
    "shopee": {
        "url": "https://shopee.vn/buyer/login",
        "phone": "0333",
        "password": "123"
    }
}

class EnhancedAutomationWorker(QThread):
    """Enhanced worker class for automation tasks"""

    log_signal = pyqtSignal(str)
    progress_signal = pyqtSignal(int)
    error_signal = pyqtSignal(str)
    result_signal = pyqtSignal(object)
    finished_signal = pyqtSignal(bool)

    def __init__(self, task=None, keyword="", email="", password="", max_results=10,
                 headless=False, proxy=None, delay=0.0, pages=1, chrome_config=None):
        super().__init__()
        self.task = task
        self.keyword = keyword
        self.email = email
        self.password = password
        self.max_results = max_results
        self.headless = headless
        self.proxy = proxy
        self.delay = delay
        self.pages = pages
        self.chrome_config = chrome_config or {}
        self.running = False
        self.driver = None
        self.service = None

    def setup_driver(self):
        """Setup Brave driver with advanced options"""
        try:
            # Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n Brave
            brave_path = self.chrome_config.get("chrome_path")
            if not brave_path or not os.path.exists(brave_path):
                raise Exception(f"Kh√¥ng t√¨m th·∫•y Brave t·∫°i: {brave_path}")

            options = Options()
            
            # Thi·∫øt l·∫≠p ƒë∆∞·ªùng d·∫´n Brave
            options.binary_location = brave_path
            
            # Thi·∫øt l·∫≠p profile
            if self.chrome_config.get("profile_path"):
                user_data_dir = os.path.dirname(self.chrome_config['profile_path'])
                profile_dir = os.path.basename(self.chrome_config['profile_path'])
                
                if not os.path.exists(user_data_dir):
                    os.makedirs(user_data_dir, exist_ok=True)
                    
                options.add_argument(f"--user-data-dir={user_data_dir}")
                options.add_argument(f"--profile-directory={profile_dir}")

            # Th√™m c√°c tham s·ªë ƒë·∫∑c bi·ªát cho Brave
            for arg in self.chrome_config.get("brave_specific_args", []):
                options.add_argument(arg)

            # Th√™m c√°c t√πy ch·ªçn b·ªï sung
            if self.headless:
                options.add_argument("--headless=new")
            
            if self.proxy:
                options.add_argument(f'--proxy-server={self.proxy}')

            # Th√™m c√°c tham s·ªë ƒë·ªÉ tr√°nh ph√°t hi·ªán automation
            options.add_experimental_option("excludeSwitches", ["enable-automation"])
            options.add_experimental_option('useAutomationExtension', False)
            options.add_argument("--disable-blink-features=AutomationControlled")

            # Kh·ªüi t·∫°o driver
            service = Service(ChromeDriverManager().install())
            self.driver = webdriver.Chrome(service=service, options=options)
            
            # Thi·∫øt l·∫≠p timeout m·∫∑c ƒë·ªãnh
            self.driver.set_page_load_timeout(30)
            self.driver.implicitly_wait(10)
            
            # T·ªëi ƒëa h√≥a c·ª≠a s·ªï
            self.driver.maximize_window()
            
            # Ki·ªÉm tra xem driver c√≥ ho·∫°t ƒë·ªông kh√¥ng
            self.driver.current_window_handle
            
            self.log_signal.emit("‚úÖ Kh·ªüi t·∫°o tr√¨nh duy·ªát th√†nh c√¥ng")
            return True
            
        except Exception as e:
            self.log_signal.emit(f"‚ùå L·ªói kh·ªüi t·∫°o tr√¨nh duy·ªát: {str(e)}")
            if self.driver:
                try:
                    self.driver.quit()
                except:
                    pass
            return False

    def stop(self):
        """Stop the worker thread"""
        self.running = False
        if self.driver:
            try:
                self.driver.quit()
            except:
                pass
        if self.service:
            try:
                self.service.stop()
            except:
                pass

    def run(self):
        """Main execution method"""
        try:
            # Ki·ªÉm tra xem c√≥ task v√† keyword kh√¥ng
            if not self.task:
                self.error_signal.emit("Ch∆∞a ch·ªçn task ƒë·ªÉ th·ª±c hi·ªán")
                return
                
            if self.task == "google" and not self.keyword:
                self.error_signal.emit("Ch∆∞a nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm")
                return
                
            # B·∫Øt ƒë·∫ßu ch·∫°y
            self.running = True
            self.progress_signal.emit(0)

            if self.task == "google":
                self.google_search()
            elif self.task == "facebook":
                self.facebook_login()
            elif self.task == "shopee":
                self.shopee_scrape()
            else:
                raise ValueError(f"Unknown task: {self.task}")
                
        except Exception as e:
            self.log_signal.emit(f"‚ùå L·ªói: {str(e)}")
            self.error_signal.emit(str(e))
        finally:
            self.running = False
            if self.driver:
                try:
                    self.driver.quit()
                except:
                    pass
            self.finished_signal.emit(True)

    def google_search(self):
        """Perform a Google search using Brave"""
        if not self.setup_driver():
            self.error_signal.emit("Kh√¥ng th·ªÉ kh·ªüi t·∫°o driver")
            return

        try:
            self.log_signal.emit("üîç B·∫Øt ƒë·∫ßu t√¨m ki·∫øm...")
            self.progress_signal.emit(10)

            # Truy c·∫≠p Google
            self.driver.get(GOOGLE_URL)
            self.progress_signal.emit(30)
            self.log_signal.emit("ƒê√£ m·ªü Google")

            # Ch·ªù v√† nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm
            search_box = WebDriverWait(self.driver, 10).until(
                EC.presence_of_element_located((By.NAME, "q"))
            )
            search_box.clear()
            search_box.send_keys(self.keyword)
            self.log_signal.emit(f"ƒê√£ nh·∫≠p t·ª´ kh√≥a: {self.keyword}")
            self.progress_signal.emit(50)

            # Submit t√¨m ki·∫øm
            search_box.submit()
            self.log_signal.emit("ƒê√£ g·ª≠i y√™u c·∫ßu t√¨m ki·∫øm")
            self.progress_signal.emit(70)

            # Ch·ªù k·∫øt qu·∫£ v√† thu th·∫≠p
            WebDriverWait(self.driver, 10).until(
                EC.presence_of_element_located((By.ID, "search"))
            )
            self.log_signal.emit("ƒê√£ nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£")

            results = []
            elements = self.driver.find_elements(By.CSS_SELECTOR, "div.g")
            
            # N·∫øu kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ v·ªõi CSS selector c≈©, th·ª≠ selector m·ªõi
            if not elements:
                elements = self.driver.find_elements(By.XPATH, "//div[contains(@class, 'g')]")

            # Thu th·∫≠p k·∫øt qu·∫£
            count = 0
            for element in elements:
                if count >= self.max_results:
                    break
                    
                try:
                    # T√¨m ti√™u ƒë·ªÅ v√† link
                    title_element = element.find_element(By.CSS_SELECTOR, "h3")
                    link_element = element.find_element(By.CSS_SELECTOR, "a")
                    
                    title = title_element.text
                    url = link_element.get_attribute("href")
                    
                    if title and url:
                        results.append((title, url))
                        count += 1
                        self.log_signal.emit(f"‚úÖ ƒê√£ t√¨m th·∫•y: {title}")
                except:
                    continue

            self.progress_signal.emit(90)
            self.log_signal.emit(f"‚úÖ ƒê√£ t√¨m th·∫•y {len(results)} k·∫øt qu·∫£")
            
            # G·ª≠i k·∫øt qu·∫£
            self.result_signal.emit(results)
            self.progress_signal.emit(100)
            return True

        except Exception as e:
            self.error_signal.emit(f"L·ªói khi t√¨m ki·∫øm: {str(e)}")
            return False

    def facebook_login(self):
        """Login to Facebook using Brave"""
        if not self.setup_driver():
            self.error_signal.emit("Kh√¥ng th·ªÉ kh·ªüi t·∫°o driver")
            return False

        try:
            self.log_signal.emit("üåê ƒêang truy c·∫≠p Facebook...")
            self.progress_signal.emit(10)
            
            # Truy c·∫≠p Facebook
            self.driver.get(SOCIAL_ACCOUNTS["facebook"]["url"])
            self.progress_signal.emit(30)
            
            # Ch·ªù form ƒëƒÉng nh·∫≠p
            WebDriverWait(self.driver, 10).until(
                EC.presence_of_element_located((By.ID, "email"))
            )
            
            # Nh·∫≠p th√¥ng tin ƒëƒÉng nh·∫≠p
            email_field = self.driver.find_element(By.ID, "email")
            pass_field = self.driver.find_element(By.ID, "pass")
            
            email_field.clear()
            email_field.send_keys(self.email)
            self.log_signal.emit("üìß ƒê√£ nh·∫≠p email")
            
            pass_field.clear()
            pass_field.send_keys(self.password)
            self.log_signal.emit("üîë ƒê√£ nh·∫≠p m·∫≠t kh·∫©u")
            
            self.progress_signal.emit(50)
            
            # Click n√∫t ƒëƒÉng nh·∫≠p
            login_button = self.driver.find_element(By.NAME, "login")
            login_button.click()
            self.log_signal.emit("üîÑ ƒêang ƒëƒÉng nh·∫≠p...")
            
            # Ch·ªù ƒëƒÉng nh·∫≠p th√†nh c√¥ng
            time.sleep(5)  # Ch·ªù cho qu√° tr√¨nh ƒëƒÉng nh·∫≠p ho√†n t·∫•t
            
            # Ki·ªÉm tra ƒëƒÉng nh·∫≠p th√†nh c√¥ng
            if "checkpoint" in self.driver.current_url:
                self.error_signal.emit("T√†i kho·∫£n y√™u c·∫ßu x√°c minh b·∫£o m·∫≠t")
                return False
                
            if "login" in self.driver.current_url:
                self.error_signal.emit("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i - Ki·ªÉm tra l·∫°i th√¥ng tin")
                return False
                
            self.progress_signal.emit(80)
            self.log_signal.emit("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!")
            
            # L∆∞u th√¥ng tin phi√™n ƒëƒÉng nh·∫≠p
            result = {
                "status": "success",
                "message": "ƒêƒÉng nh·∫≠p th√†nh c√¥ng",
                "url": self.driver.current_url
            }
            
            self.result_signal.emit(result)
            self.progress_signal.emit(100)
            return True
            
        except Exception as e:
            self.error_signal.emit(f"L·ªói ƒëƒÉng nh·∫≠p: {str(e)}")
            return False

    def facebook_post(self, content, images=None):
        """Post content to Facebook"""
        if not self.driver:
            self.error_signal.emit("Ch∆∞a ƒëƒÉng nh·∫≠p Facebook")
            return False
            
        try:
            self.log_signal.emit("üìù Chu·∫©n b·ªã ƒëƒÉng b√†i...")
            self.progress_signal.emit(10)
            
            # Truy c·∫≠p trang ch·ªß Facebook
            self.driver.get(SOCIAL_ACCOUNTS["facebook"]["url"])
            self.progress_signal.emit(20)
            
            # Ch·ªù v√† click v√†o √¥ "B·∫°n ƒëang nghƒ© g√¨?"
            create_post_button = WebDriverWait(self.driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "[aria-label='T·∫°o b√†i vi·∫øt'], [aria-label='Create post']"))
            )
            create_post_button.click()
            
            self.log_signal.emit("‚úçÔ∏è ƒêang m·ªü form ƒëƒÉng b√†i...")
            self.progress_signal.emit(40)
            
            # Ch·ªù form ƒëƒÉng b√†i xu·∫•t hi·ªán
            post_box = WebDriverWait(self.driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "[aria-label='B·∫°n ƒëang nghƒ© g√¨?'], [aria-label='What\\'s on your mind?'], [contenteditable='true']"))
            )
            
            # Nh·∫≠p n·ªôi dung b√†i vi·∫øt
            self.driver.execute_script("arguments[0].innerHTML = arguments[1]", post_box, content)
            self.log_signal.emit("üìù ƒê√£ nh·∫≠p n·ªôi dung b√†i vi·∫øt")
            self.progress_signal.emit(60)
            
            # Th√™m ·∫£nh n·∫øu c√≥
            if images:
                try:
                    # Click n√∫t th√™m ·∫£nh
                    photo_button = self.driver.find_element(By.CSS_SELECTOR, "[aria-label='Photo/video']")
                    photo_button.click()
                    
                    # Ch·ªù input file xu·∫•t hi·ªán
                    file_input = WebDriverWait(self.driver, 10).until(
                        EC.presence_of_element_located((By.CSS_SELECTOR, "input[type='file']"))
                    )
                    
                    # Upload t·ª´ng ·∫£nh
                    for image in images:
                        if os.path.exists(image):
                            file_input.send_keys(image)
                            time.sleep(2)  # Ch·ªù upload
                            
                    self.log_signal.emit("üñºÔ∏è ƒê√£ th√™m ·∫£nh v√†o b√†i vi·∫øt")
                except Exception as e:
                    self.log_signal.emit(f"‚ö†Ô∏è Kh√¥ng th·ªÉ th√™m ·∫£nh: {str(e)}")
            
            self.progress_signal.emit(80)
            
            # Click n√∫t ƒêƒÉng
            post_button = WebDriverWait(self.driver, 10).until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, "[aria-label='ƒêƒÉng'], [aria-label='Post']"))
            )
            post_button.click()
            
            self.log_signal.emit("üîÑ ƒêang ƒëƒÉng b√†i...")
            
            # Ch·ªù ƒëƒÉng b√†i th√†nh c√¥ng
            time.sleep(5)
            
            # Ki·ªÉm tra ƒëƒÉng b√†i th√†nh c√¥ng
            success = False
            try:
                success_msg = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_element_located((By.XPATH, "//*[contains(text(), 'ƒë√£ ƒë∆∞·ª£c ƒëƒÉng') or contains(text(), 'was posted')]"))
                )
                if success_msg:
                    success = True
            except:
                pass
                
            if success:
                self.log_signal.emit("‚úÖ ƒêƒÉng b√†i th√†nh c√¥ng!")
                result = {
                    "status": "success",
                    "message": "ƒêƒÉng b√†i th√†nh c√¥ng",
                    "url": self.driver.current_url
                }
                self.result_signal.emit(result)
                self.progress_signal.emit(100)
                return True
            else:
                self.error_signal.emit("Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒëƒÉng b√†i th√†nh c√¥ng")
                return False
                
        except Exception as e:
            self.error_signal.emit(f"L·ªói khi ƒëƒÉng b√†i: {str(e)}")
            return False

    def shopee_scrape(self):
        """Scrape products from Shopee"""
        if not self.setup_driver():
            self.error_signal.emit("Kh√¥ng th·ªÉ kh·ªüi t·∫°o driver")
            return False
            
        try:
            self.log_signal.emit("üîç B·∫Øt ƒë·∫ßu t√¨m ki·∫øm tr√™n Shopee...")
            self.progress_signal.emit(10)
            
            # Truy c·∫≠p Shopee
            self.driver.get(SOCIAL_ACCOUNTS["shopee"]["url"])
            self.progress_signal.emit(20)
            
            # ƒê·ª£i v√† ƒë√≥ng popup n·∫øu c√≥
            try:
                close_button = WebDriverWait(self.driver, 5).until(
                    EC.element_to_be_clickable((By.CSS_SELECTOR, ".shopee-popup__close-btn"))
                )
                close_button.click()
            except:
                pass
                
            # Ch·ªù √¥ t√¨m ki·∫øm
            search_box = WebDriverWait(self.driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, ".shopee-searchbar-input__input"))
            )
            
            # Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm
            search_box.clear()
            search_box.send_keys(self.keyword)
            self.log_signal.emit(f"üîç ƒê√£ nh·∫≠p t·ª´ kh√≥a: {self.keyword}")
            
            # Nh·∫•n Enter ƒë·ªÉ t√¨m ki·∫øm
            search_box.send_keys(Keys.RETURN)
            self.progress_signal.emit(40)
            
            # Ch·ªù k·∫øt qu·∫£ t√¨m ki·∫øm
            time.sleep(5)  # Ch·ªù trang load
            
            results = []
            current_page = 1
            
            while current_page <= self.pages and len(results) < self.max_results:
                self.log_signal.emit(f"üìÑ ƒêang x·ª≠ l√Ω trang {current_page}/{self.pages}")
                
                # Ch·ªù danh s√°ch s·∫£n ph·∫©m
                WebDriverWait(self.driver, 10).until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, ".shopee-search-item-result__items"))
                )
                
                # Thu th·∫≠p s·∫£n ph·∫©m
                items = self.driver.find_elements(By.CSS_SELECTOR, ".shopee-search-item-result__item")
                
                for item in items:
                    if len(results) >= self.max_results:
                        break
                        
                    try:
                        # L·∫•y th√¥ng tin s·∫£n ph·∫©m
                        name = item.find_element(By.CSS_SELECTOR, "._3GAFiR").text
                        price = item.find_element(By.CSS_SELECTOR, "._1xk7ak").text
                        url = item.find_element(By.CSS_SELECTOR, "a").get_attribute("href")
                        
                        if name and price and url:
                            results.append((name, price, url))
                            self.log_signal.emit(f"‚úÖ ƒê√£ t√¨m th·∫•y: {name}")
                    except:
                        continue
                        
                self.progress_signal.emit(40 + (50 * current_page // self.pages))
                
                # Chuy·ªÉn trang n·∫øu c·∫ßn
                if current_page < self.pages:
                    try:
                        next_button = self.driver.find_element(By.CSS_SELECTOR, ".shopee-mini-page-controller__next-btn")
                        if "disabled" not in next_button.get_attribute("class"):
                            next_button.click()
                            time.sleep(3)  # Ch·ªù trang m·ªõi load
                            current_page += 1
                        else:
                            break
                    except:
                        break
                else:
                    break
                    
            self.log_signal.emit(f"‚úÖ ƒê√£ t√¨m th·∫•y {len(results)} s·∫£n ph·∫©m")
            
            # G·ª≠i k·∫øt qu·∫£
            self.result_signal.emit(results)
            self.progress_signal.emit(100)
            return True
            
        except Exception as e:
            self.error_signal.emit(f"L·ªói khi t√¨m ki·∫øm tr√™n Shopee: {str(e)}")
            return False
